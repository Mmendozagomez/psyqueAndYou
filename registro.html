<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reg√≠strate y Encuentra tu Psic√≥logo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css"> </head>
<body class="bg-light">

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                
                <div class="progress mb-4" style="height: 5px;">
                    <div class="progress-bar" id="barraProgreso" role="progressbar" style="width: 33%;"></div>
                </div>

                <div class="card shadow border-0 p-4">
                    
                    <div id="paso1">
                        <h3 class="text-primary fw-bold text-center">Crear Cuenta</h3>
                        <p class="text-center text-muted">Primero, tus datos para guardar tu expediente.</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombreUsuario" placeholder="Ej. Mar√≠a P√©rez">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Correo Electr√≥nico</label>
                            <input type="email" class="form-control" id="emailUsuario" placeholder="nombre@email.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contrase√±a</label>
                            <input type="password" class="form-control" id="passUsuario"> placeholder="******">
                        </div>

                        <button class="btn btn-primary w-100 mt-3" onclick="irAlPaso2()">
                            Siguiente: Hacer Cuestionario
                        </button>
                        <p class="text-center mt-3"><small>¬øYa tienes cuenta? <a href="login.html">Inicia sesi√≥n</a></small></p>
                    </div>

                    <div id="paso2" class="d-none">
                        <h3 class="text-primary fw-bold text-center">Cu√©ntanos sobre ti</h3>
                        <p class="text-center text-muted">Para asignarte al mejor especialista.</p>

                        <div class="mb-3">
                            <label class="form-label fw-bold">¬øMotivo de consulta?</label>
                            <select class="form-select" id="motivoConsulta">
                                <option value="">Selecciona...</option>
                                <option value="ansiedad">Ansiedad / Estr√©s</option>
                                <option value="pareja">Problemas de Pareja</option>
                                <option value="infantil">Ni√±os / Adolescentes</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Preferencia de Terapeuta</label>
                            <select class="form-select" id="preferenciaGenero">
                                <option value="indiferente">Indiferente</option>
                                <option value="mujer">Mujer</option>
                                <option value="hombre">Hombre</option>
                            </select>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-outline-secondary" onclick="volverAlPaso1()">Atr√°s</button>
                            <button class="btn btn-primary" onclick="finalizarRegistro()">Ver mi Psic√≥logo</button>
                        </div>
                    </div>

                    <div id="paso3" class="d-none text-center">
                        <div class="text-success mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                        </div>
                        <h3 class="fw-bold">¬°Cuenta Creada!</h3>
                        <p>Hola <span id="saludoNombre" class="fw-bold"></span>, hemos encontrado tu match ideal:</p>
                        
                        <div class="card bg-light p-3 mt-3 border-primary">
                            <h4 class="text-primary mb-0" id="nombreMatch">Nombre Dr.</h4>
                            <small class="text-muted" id="especialidadMatch">Especialidad</small>
                        </div>

                        <button class="btn btn-success w-100 btn-lg mt-4" onclick="window.location.href='panel-paciente.html'">
                        Agendar mi primera cita
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

  <script type="module">
    // 1. Importamos las herramientas REALES
    import { auth, db } from './firebase-config.js';
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Hacemos las funciones globales para que el HTML las encuentre
    window.irAlPaso2 = function() {
        let nombre = document.getElementById("nombreUsuario").value;
        let email = document.getElementById("emailUsuario").value; // ¬°Aseg√∫rate de tener este input en el HTML!
        let pass = document.getElementById("passUsuario").value;   // ¬°Y este tambi√©n!

        if(nombre === "" || email === "" || pass === "") {
            alert("Por favor llena todos los datos del paso 1");
            return;
        }

        // Si hay datos, avanzamos visualmente
        document.getElementById("paso1").classList.add("d-none");
        document.getElementById("paso2").classList.remove("d-none");
        document.getElementById("barraProgreso").style.width = "66%";
    }

    window.volverAlPaso1 = function() {
        document.getElementById("paso2").classList.add("d-none");
        document.getElementById("paso1").classList.remove("d-none");
        document.getElementById("barraProgreso").style.width = "33%";
    }

    window.finalizarRegistro = async function() {
        // Obtenemos los datos
        const email = document.getElementById("emailUsuario").value;
        const password = document.getElementById("passUsuario").value;
        const nombre = document.getElementById("nombreUsuario").value;
        const motivo = document.getElementById("motivoConsulta").value;
        
        // Validamos el motivo
        if(motivo === "") { alert("Selecciona un motivo"); return; }

        try {
            // üõë AQU√ç OCURRE LA MAGIA: CREAMOS EL USUARIO EN GOOGLE
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // Guardamos los datos extra (nombre, motivo) en la Base de Datos
            await setDoc(doc(db, "pacientes", user.uid), {
                nombre: nombre,
                email: email,
                motivo: motivo,
                rol: "paciente",
                fechaRegistro: new Date()
            });

            // Si todo sale bien, mostramos el √©xito
            mostrarExito(nombre, motivo);

        } catch (error) {
            // Si algo sale mal (ej: el correo ya existe)
            console.error(error);
            if (error.code === 'auth/email-already-in-use') {
                alert("Este correo ya est√° registrado.");
            } else if (error.code === 'auth/weak-password') {
                alert("La contrase√±a debe tener al menos 6 caracteres.");
            } else {
                alert("Error: " + error.message);
            }
        }
    }

    function mostrarExito(nombre, motivo) {
        // L√≥gica del Match (simplificada)
        let match = "Dr. Asignado";
        let especialidad = "General";
        if (motivo === "ansiedad") { match = "Lic. Ana Garc√≠a"; especialidad = "Ansiedad"; }
        else if (motivo === "pareja") { match = "Dr. Roberto M√©ndez"; especialidad = "Parejas"; }
        
        document.getElementById("saludoNombre").innerText = nombre;
        document.getElementById("nombreMatch").innerText = match;
        document.getElementById("especialidadMatch").innerText = especialidad;

        document.getElementById("paso2").classList.add("d-none");
        document.getElementById("paso3").classList.remove("d-none");
        document.getElementById("barraProgreso").style.width = "100%";
        document.getElementById("barraProgreso").classList.add("bg-success");
    }
</script>

</body>
</html>